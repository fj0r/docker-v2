FROM nnurphy/v2ray

###### s6
ENV s6overlay_version=2.0.0.0
ARG httpbin_url=https://iffy.me/pub/httpbox_amd64.tar.gz
ARG s6overlay_url=https://github.com/just-containers/s6-overlay/releases/download/v${s6overlay_version}/s6-overlay-amd64.tar.gz
RUN set -ex \
  ; apt-get update \
  ; apt-get install -y --no-install-recommends \
      jq \
      curl \
      nginx \
  ; apt-get autoremove -y && apt-get clean -y && rm -rf /var/lib/apt/lists/* \
  \
  ; curl --fail --silent -L ${s6overlay_url} > /tmp/s6overlay.tar.gz \
  ; tar xzf /tmp/s6overlay.tar.gz -C / --exclude="./bin" \
  ; tar xzf /tmp/s6overlay.tar.gz -C /usr ./bin \
  ; rm -f /tmp/s6overlay.tar.gz \
  \
  ; sed -i '1i\daemon off;' /etc/nginx/nginx.conf \
  ; rm -rf /etc/nginx/sites-available/* \
  ; rm -rf /etc/nginx/sites-enabled/* \
  \
  ; mkdir /pub \
  ; ln -s /pub /srv/pub \
  ; curl ${httpbin_url} | tar zxvf - -C /usr/bin


COPY services.d /etc/services.d
COPY 01-gen-token /etc/cont-init.d

ENV PATH /usr/bin/v2ray:$PATH
COPY nginx.conf /etc/nginx/conf.d/default.conf
COPY client.json /etc/v2ray/client.json

ENTRYPOINT [ "/init" ]