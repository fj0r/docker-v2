FROM nnurphy/httpbin as httpbin
FROM nnurphy/v2ray

COPY --from=httpbin /bin/go-httpbin /usr/bin/go-httpbin
###### s6
ARG s6url=https://github.com/just-containers/s6-overlay/releases/download/v1.22.1.0/s6-overlay-amd64.tar.gz
RUN set -ex \
  ; sed -i 's/dl-cdn.alpinelinux.org/mirror.tuna.tsinghua.edu.cn/g' /etc/apk/repositories \
  ; apk update && apk upgrade \
  ; rm -rf /var/cache/apk/* \
  ; apk add --no-cache \
      openssh-client \
      tzdata \
      curl \
      nginx \
      jq \
  ; curl --fail --silent -L ${s6url} | tar xzvf - -C /

RUN set -ex \
  ; sed -i '1i\daemon off;' /etc/nginx/nginx.conf \
  ; rm -rf /etc/nginx/sites-available/* \
  ; rm -rf /etc/nginx/sites-enabled/* \
  ; mkdir -p /run/nginx


COPY services.d /etc/services.d
COPY 01-gen-token /etc/cont-init.d

ENV PATH /usr/bin/v2ray:$PATH
COPY nginx.conf /etc/nginx/conf.d/default.conf
COPY client.json /etc/v2ray/client.json
RUN set -ex \
  ; mkdir /pub \
  ; ln -s /pub /srv/pub

ENTRYPOINT [ "/init" ]